From cef3d5739547211bc9f8df2628dd3ff99ef87408 Mon Sep 17 00:00:00 2001
From: Joseph Liu <kwliu@nuvoton.com>
Date: Tue, 24 Sep 2019 18:22:27 +0800
Subject: [PATCH] stmmac: Add eee fixup disable

Under some circumstances, a very high interrupt
rate is generated by lpi_irq on stmmac driver.
Workaround on some boards SoCs/boards can be
added to disable eee advertising.

Signed-off-by: Joseph Liu <kwliu@nuvoton.com>
---
 drivers/net/ethernet/stmicro/stmmac/stmmac_main.c     | 3 +++
 drivers/net/ethernet/stmicro/stmmac/stmmac_platform.c | 3 +++
 include/linux/stmmac.h                                | 1 +
 3 files changed, 7 insertions(+)

diff --git a/drivers/net/ethernet/stmicro/stmmac/stmmac_main.c b/drivers/net/ethernet/stmicro/stmmac/stmmac_main.c
index b14f46a57154..891939f55afe 100644
--- a/drivers/net/ethernet/stmicro/stmmac/stmmac_main.c
+++ b/drivers/net/ethernet/stmicro/stmmac/stmmac_main.c
@@ -416,6 +416,9 @@ bool stmmac_eee_init(struct stmmac_priv *priv)
 	if (priv->dma_cap.eee) {
 		int tx_lpi_timer = priv->tx_lpi_timer;
 
+		if (priv->plat->eee_force_disable)
+			goto out;
+
 		/* Check if the PHY supports EEE */
 		if (phy_init_eee(ndev->phydev, 1)) {
 			/* To manage at run-time if the EEE cannot be supported
diff --git a/drivers/net/ethernet/stmicro/stmmac/stmmac_platform.c b/drivers/net/ethernet/stmicro/stmmac/stmmac_platform.c
index 9b5218a8c15b..e61db609fccd 100644
--- a/drivers/net/ethernet/stmicro/stmmac/stmmac_platform.c
+++ b/drivers/net/ethernet/stmicro/stmmac/stmmac_platform.c
@@ -432,6 +432,9 @@ stmmac_probe_config_dt(struct platform_device *pdev, const char **mac)
 	plat->en_tx_lpi_clockgating =
 		of_property_read_bool(np, "snps,en-tx-lpi-clockgating");
 
+	plat->eee_force_disable =
+		of_property_read_bool(np, "snps,eee-force-disable");
+
 	/* Set the maxmtu to a default of JUMBO_LEN in case the
 	 * parameter is not present in the device tree.
 	 */
diff --git a/include/linux/stmmac.h b/include/linux/stmmac.h
index 1a0bb622cf10..711edbd07634 100644
--- a/include/linux/stmmac.h
+++ b/include/linux/stmmac.h
@@ -166,6 +166,7 @@ struct plat_stmmacenet_data {
 	void (*exit)(struct platform_device *pdev, void *priv);
 	struct mac_device_info *(*setup)(void *priv);
 	void *bsp_priv;
+	int eee_force_disable;
 	struct clk *stmmac_clk;
 	struct clk *pclk;
 	struct clk *clk_ptp_ref;
-- 
2.17.1

